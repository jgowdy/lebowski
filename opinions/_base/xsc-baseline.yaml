version: "1.0"
opinion_name: xsc-baseline
purity_level: configure-only

description: |
  XSC Baseline Opinion
  
  Build packages with the XSC toolchain (x86_64-xsc-linux-gnu-gcc)
  to generate ring-based syscalls instead of syscall instructions.
  
  This opinion template should be extended by package-specific XSC opinions.
  
  REQUIREMENTS:
  - XSC toolchain installed at /opt/xsc-toolchain/
  - libxsc-rt.so available for linking
  - Container image: lebowski/builder:xsc
  
  VERIFICATION:
  After build, verify zero syscall instructions:
    objdump -d <binary> | grep syscall
  (Expected: no output)

maintainer:
  name: XSC Project
  email: xsc@lebowski.org

tags: [xsc, security, ring-syscalls, zero-syscall]
debian_versions: [bookworm, jammy]

modifications:
  env:
    # Use XSC cross-compiler toolchain
    CC: /opt/xsc-toolchain/bin/x86_64-xsc-linux-gnu-gcc
    CXX: /opt/xsc-toolchain/bin/x86_64-xsc-linux-gnu-g++
    AR: /opt/xsc-toolchain/bin/x86_64-xsc-linux-gnu-ar
    RANLIB: /opt/xsc-toolchain/bin/x86_64-xsc-linux-gnu-ranlib
    
    # Add XSC toolchain to PATH
    PATH: /opt/xsc-toolchain/bin:/usr/bin:/bin
    
    # XSC runtime library path
    LD_LIBRARY_PATH: /opt/xsc-toolchain/lib:/usr/local/lib
    
    # pkg-config path for XSC libraries
    PKG_CONFIG_PATH: /opt/xsc-toolchain/lib/pkgconfig

  cflags:
    # Standard hardening flags (compatible with XSC)
    - "-fstack-protector-strong"
    - "-D_FORTIFY_SOURCE=2"
    
    # Optimization for size (ring transitions have overhead)
    - "-Os"
    
    # XSC-specific: ensure proper ABI
    - "-fno-omit-frame-pointer"

  ldflags:
    # Link XSC runtime library
    - "-lxsc-rt"
    
    # Static linking preferred (avoids glibc syscalls)
    - "-static"
    
    # Ensure XSC lib path is searched
    - "-L/opt/xsc-toolchain/lib"

  configure_args:
    # Prefer static builds
    - "--enable-static"
    - "--disable-shared"
    
    # Cross-compilation settings
    - "--host=x86_64-xsc-linux-gnu"
    - "--build=x86_64-pc-linux-gnu"

verification:
  zero_syscall: true
  
  commands:
    # Extract and verify binaries
    - name: "Extract .deb package"
      cmd: "dpkg-deb -x {package}.deb /tmp/xsc-verify"
    
    - name: "Find all ELF binaries"
      cmd: "find /tmp/xsc-verify -type f -executable -exec file {} \; | grep ELF"
    
    - name: "Verify zero syscall instructions"
      cmd: "find /tmp/xsc-verify -type f -executable -exec objdump -d {} \; | grep syscall"
      expected_exit: 1  # grep returns 1 when no match (success!)
      expected_output: ""  # No syscall instructions found
