#!/bin/bash
#
# xsc-cpu-check - Verify CPU compatibility with XSC baseline
#
# Checks for required instruction sets:
# - AVX, AES-NI, PCLMULQDQ, RDRAND, F16C, SSE4.1, SSE4.2, POPCNT
#

set -euo pipefail

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Required instruction sets for XSC Ivy Bridge baseline
REQUIRED_FLAGS=(
    "avx:AVX:Advanced Vector Extensions (256-bit SIMD)"
    "aes:AES-NI:Hardware AES encryption"
    "pclmulqdq:PCLMULQDQ:Carry-less multiplication"
    "rdrand:RDRAND:Hardware random numbers"
    "f16c:F16C:Half-precision floats"
    "sse4_1:SSE4.1:Streaming SIMD Extensions 4.1"
    "sse4_2:SSE4.2:Streaming SIMD Extensions 4.2"
    "popcnt:POPCNT:Population count"
)

# Get CPU model name
CPU_MODEL=$(grep -m1 "model name" /proc/cpuinfo | cut -d: -f2 | sed 's/^[ \t]*//')

# Get CPU flags
CPU_FLAGS=$(grep -m1 "flags" /proc/cpuinfo | cut -d: -f2)

echo -e "${BOLD}XSC CPU Compatibility Check${NC}"
echo "==========================="
echo ""
echo -e "${BLUE}CPU:${NC} ${CPU_MODEL}"
echo ""
echo -e "${BOLD}Required Instruction Sets:${NC}"

ALL_PRESENT=true

for flag_spec in "${REQUIRED_FLAGS[@]}"; do
    IFS=':' read -r flag_name display_name description <<< "$flag_spec"

    if echo "$CPU_FLAGS" | grep -qw "$flag_name"; then
        echo -e "  ${GREEN}[✓]${NC} ${BOLD}${display_name}${NC} - ${description}"
    else
        echo -e "  ${RED}[✗]${NC} ${BOLD}${display_name}${NC} - ${description}"
        ALL_PRESENT=false
    fi
done

echo ""
echo -e "${BOLD}Result:${NC} "

if [ "$ALL_PRESENT" = true ]; then
    echo -e "${GREEN}✅ COMPATIBLE${NC} with XSC baseline"
    echo ""
    echo "Your CPU supports all required instruction sets."
    echo "XSC packages will run with full performance benefits:"
    echo ""
    echo "  • 5-8x faster cryptography (AES-NI)"
    echo "  • 2x wider SIMD vectors (AVX)"
    echo "  • Hardware random number generation (RDRAND)"
    echo "  • Better overall performance"
    echo ""
    exit 0
else
    echo -e "${RED}❌ NOT COMPATIBLE${NC} with XSC baseline"
    echo ""
    echo "Your CPU is missing required instruction sets."
    echo "XSC packages will NOT run on this system."
    echo ""
    echo -e "${YELLOW}Minimum CPUs:${NC}"
    echo "  • Intel: Core i3/i5/i7 3xxx (Ivy Bridge, 2012+)"
    echo "           Xeon E5 v2 (2013+)"
    echo "  • AMD:   FX-series (Piledriver, 2012+)"
    echo "           Ryzen (all, 2017+)"
    echo ""
    echo "For older CPUs, use standard Debian packages."
    echo ""
    exit 1
fi
